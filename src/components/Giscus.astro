---
/**
 * Giscus Comments Component
 * 
 * A comments widget powered by GitHub Discussions.
 * Configure via environment variables or props.
 * 
 * @see https://giscus.app for configuration options
 */

interface Props {
  /** GitHub repository in 'owner/repo' format */
  repo?: string;
  /** Repository ID from Giscus configuration */
  repoId?: string;
  /** Discussion category name */
  category?: string;
  /** Discussion category ID from Giscus configuration */
  categoryId?: string;
  /** How to map posts to discussions: 'pathname' | 'url' | 'title' | 'og:title' */
  mapping?: 'pathname' | 'url' | 'title' | 'og:title' | 'specific' | 'number';
  /** Enable reactions on main post */
  reactionsEnabled?: boolean;
  /** Emit discussion metadata */
  emitMetadata?: boolean;
  /** Input position: 'top' | 'bottom' */
  inputPosition?: 'top' | 'bottom';
  /** Giscus theme: 'light' | 'dark' | 'preferred_color_scheme' | custom URL */
  theme?: string;
  /** Language code */
  lang?: string;
  /** Load comments lazily */
  lazyLoad?: boolean;
}

const {
  repo = import.meta.env.PUBLIC_GISCUS_REPO || '',
  repoId = import.meta.env.PUBLIC_GISCUS_REPO_ID || '',
  category = import.meta.env.PUBLIC_GISCUS_CATEGORY || 'Blog Comments',
  categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID || '',
  mapping = 'pathname',
  reactionsEnabled = true,
  emitMetadata = false,
  inputPosition = 'bottom',
  theme = 'light',
  lang = 'en',
  lazyLoad = true,
} = Astro.props;

// Check if Giscus is configured
const isConfigured = repo && repoId && categoryId;
---

{isConfigured ? (
  <section class="giscus-comments mt-12 pt-8 border-t border-gray-200">
    <h2 class="text-2xl font-display font-bold text-gray-900 mb-6">Comments</h2>
    <div class="giscus-wrapper bg-white rounded-lg">
      <script
        src="https://giscus.app/client.js"
        data-repo={repo}
        data-repo-id={repoId}
        data-category={category}
        data-category-id={categoryId}
        data-mapping={mapping}
        data-strict="0"
        data-reactions-enabled={reactionsEnabled ? '1' : '0'}
        data-emit-metadata={emitMetadata ? '1' : '0'}
        data-input-position={inputPosition}
        data-theme={theme}
        data-lang={lang}
        data-loading={lazyLoad ? 'lazy' : 'eager'}
        crossorigin="anonymous"
        async
      />
    </div>
  </section>
) : (
  <!-- Giscus not configured - show nothing in production, helpful message in dev -->
  import.meta.env.DEV && (
    <section class="giscus-comments mt-12 pt-8 border-t border-gray-200">
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-yellow-800 mb-2">
          üìù Giscus Comments Not Configured
        </h3>
        <p class="text-yellow-700 text-sm">
          To enable comments, configure the following environment variables:
        </p>
        <ul class="list-disc list-inside text-yellow-700 text-sm mt-2 space-y-1">
          <li><code class="bg-yellow-100 px-1 rounded">PUBLIC_GISCUS_REPO</code> - Your GitHub repo (owner/repo)</li>
          <li><code class="bg-yellow-100 px-1 rounded">PUBLIC_GISCUS_REPO_ID</code> - Repository ID</li>
          <li><code class="bg-yellow-100 px-1 rounded">PUBLIC_GISCUS_CATEGORY_ID</code> - Category ID</li>
        </ul>
        <p class="text-yellow-700 text-sm mt-2">
          Visit <a href="https://giscus.app" class="underline hover:text-yellow-900" target="_blank" rel="noopener">giscus.app</a> to get these values.
        </p>
      </div>
    </section>
  )
)}

<style>
  .giscus-wrapper {
    min-height: 200px;
  }
  
  /* Ensure Giscus iframe fits properly */
  .giscus-wrapper :global(.giscus),
  .giscus-wrapper :global(.giscus-frame) {
    width: 100%;
  }
</style>
